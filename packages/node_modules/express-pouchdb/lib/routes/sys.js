"use strict";

var pkg    = require('../../package'),
    utils  = require('../utils'),
    uuids  = require('../uuids');
var privateKey = require('pouchdb-auth/lib/private-key');

module.exports = function (app) {
  function getSysData() {
    if (privateKey.keys) var pk = privateKey.keys[0].toPublic().armor();
    var json = {time: new Date()};
    if (pk) json.pk = pk;
    if (app.couchConfig) {
      json.vendor = app.couchConfig.getSection('vendor');
      json.uuid = getServerUUID(app.couchConfig);
    }
    return json;
  }
  // sys route, return all public sys data
  app.get('/_sys', function (req, res) {
    var json = getSysData();
    utils.sendJSON(res, 200, json);
  });
  // sys subroute, return a public sys data
  app.get('/_sys/:key', function (req, res) {
    var vKey = req.params.key;
    var json = getSysData();
    if (typeof json[vKey] === 'undefined') {
      return utils.sendJSON(res, 404, {
        error: "not_found",
        reason: "unknown_config_value"
      });
    }
    utils.sendJSON(res, 200, json[vKey]);
  });
};

function getServerUUID(config) {
  var uuid = config.get('couchdb', 'uuid');
  if (!uuid) {
    uuid = uuids(1)[0];
    config.set('couchdb', 'uuid', uuid, function() {});
  }
  return uuid;
}


